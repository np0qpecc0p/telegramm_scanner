<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Telegram Scanner MiniApp</title>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
<style>
  body { font-family: sans-serif; padding: 10px; text-align: center; }
  video, canvas { border: 1px solid #ccc; width: 280px; border-radius: 8px; margin: 5px 0; }
  button { margin: 5px; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer; }
  #previewContainer img { width: 80px; margin: 3px; border-radius: 6px; border: 1px solid #ddd; }
</style>
</head>
<body>
<h2>üìÑ Telegram Mini Scanner</h2>
<video autoplay></video><br>
<button id="snap">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
<button id="ocrToggle">üß† OCR: –í—ã–∫–ª</button>
<button id="preview">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä PDF</button>
<button id="send">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
<div id="previewContainer"></div>
<canvas style="display:none;"></canvas>

<script>
const video = document.querySelector('video');
const canvas = document.querySelector('canvas');
const previewContainer = document.getElementById('previewContainer');
let images = [];
let useOCR = false;

// –ö–∞–º–µ—Ä–∞
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  } catch (err) {
    alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err.message);
  }
}
startCamera();

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ OCR
document.getElementById('ocrToggle').onclick = () => {
  useOCR = !useOCR;
  document.getElementById('ocrToggle').innerText = useOCR ? "üß† OCR: –í–∫–ª" : "üß† OCR: –í—ã–∫–ª";
};

// –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
document.getElementById('snap').onclick = () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // –ß–µ—Ä–Ω–æ-–±–µ–ª—ã–π —Ñ–∏–ª—å—Ç—Ä (–∏–º–∏—Ç–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞)
  let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  let data = imageData.data;
  for (let i = 0; i < data.length; i += 4) {
    let avg = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
    data[i] = data[i + 1] = data[i + 2] = avg;
  }
  ctx.putImageData(imageData, 0, 0);

  const imgData = canvas.toDataURL('image/png');
  images.push(imgData);

  const imgEl = document.createElement('img');
  imgEl.src = imgData;
  previewContainer.appendChild(imgEl);
};

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF
async function generatePDFBlob() {
  const { PDFDocument, StandardFonts } = PDFLib;
  const pdfDoc = await PDFDocument.create();
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

  for (let imgData of images) {
    const imgBytes = await fetch(imgData).then(r => r.arrayBuffer());
    const img = await pdfDoc.embedPng(imgBytes);
    const page = pdfDoc.addPage([img.width, img.height]);
    page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });

    if (useOCR) {
      const result = await Tesseract.recognize(imgData, 'eng');
      const text = result.data.text.trim();
      if (text) page.drawText(text, { x: 10, y: img.height - 20, size: 12, font });
    }
  }

  const pdfBytes = await pdfDoc.save();
  return new Blob([pdfBytes], { type: 'application/pdf' });
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä PDF –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
document.getElementById('preview').onclick = async () => {
  if (images.length === 0) { alert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ!'); return; }
  const pdfBlob = await generatePDFBlob();
  const url = URL.createObjectURL(pdfBlob);
  window.open(url, '_blank');
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ PDF
document.getElementById('send').onclick = async () => {
  if (images.length === 0) { alert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ!'); return; }

  const pdfBlob = await generatePDFBlob();
  const reader = new FileReader();
  reader.onload = () => {
    const base64 = reader.result.split(',')[1];
    Telegram.WebApp.sendData(JSON.stringify({
      fileName: 'document.pdf',
      fileData: base64
    }));
    alert('üì§ PDF –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É!');
  };
  reader.readAsDataURL(pdfBlob);
};
</script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
