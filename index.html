<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Telegram Scanner MiniApp</title>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
<style>
  video, canvas { border: 1px solid #ccc; width: 300px; height: auto; margin: 5px 0; }
  button { margin: 5px; padding: 8px 12px; }
</style>
</head>
<body>
<h1>Mini Scanner</h1>
<video autoplay></video><br>
<button id="snap">Сделать фото</button>
<button id="ocrToggle">OCR: Вкл/Выкл</button>
<button id="send">Отправить PDF в Telegram</button>
<canvas style="display:none;"></canvas>

<script>
const video = document.querySelector('video');
const canvas = document.querySelector('canvas');
let images = [];
let useOCR = false;

// Камера
async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
}
startCamera();

// Переключение OCR
document.getElementById('ocrToggle').onclick = () => {
  useOCR = !useOCR;
  alert("OCR " + (useOCR ? "включен" : "выключен"));
};

// Сделать фото с фильтром "скан"
document.getElementById('snap').onclick = () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Черно-белое преобразование
  let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  let data = imageData.data;
  for (let i=0; i<data.length; i+=4) {
    let avg = 0.3*data[i] + 0.59*data[i+1] + 0.11*data[i+2];
    data[i] = data[i+1] = data[i+2] = avg;
  }
  ctx.putImageData(imageData, 0, 0);

  images.push(canvas.toDataURL('image/png'));
  alert('Фото добавлено! Всего страниц: ' + images.length);
};

// Генерация PDF с опциональным OCR
async function generatePDFBlob() {
  const { PDFDocument, StandardFonts } = PDFLib;
  const pdfDoc = await PDFDocument.create();
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

  for (let imgData of images) {
    const imgBytes = await fetch(imgData).then(r => r.arrayBuffer());
    const img = await pdfDoc.embedPng(imgBytes);
    const page = pdfDoc.addPage([img.width, img.height]);
    page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });

    if (useOCR) {
      // OCR через tesseract.js
      const result = await Tesseract.recognize(imgData, 'eng');
      const text = result.data.text.trim();
      if (text.length > 0) {
        page.drawText(text, { x: 10, y: img.height - 20, size: 12, font });
      }
    }
  }

  const pdfBytes = await pdfDoc.save();
  return new Blob([pdfBytes], { type: 'application/pdf' });
}

// Отправка PDF в Telegram
document.getElementById('send').onclick = async () => {
  if (images.length === 0) { alert('Сначала сделайте хотя бы одно фото!'); return; }

  const pdfBlob = await generatePDFBlob();
  const reader = new FileReader();
  reader.onload = () => {
    const base64 = reader.result.split(',')[1];
    Telegram.WebApp.sendData(JSON.stringify({
      fileName: 'document.pdf',
      fileData: base64
    }));
    alert('PDF отправлен боту!');
  };
  reader.readAsDataURL(pdfBlob);
};

</script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</body>
</html>
